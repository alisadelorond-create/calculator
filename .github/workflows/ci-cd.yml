name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  test:
    name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: pip install -r requirements.txt
      
    - name: ‚úÖ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: python -m unittest discover tests -v

  deploy:
    name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ Production
    runs-on: self-hosted
    needs: test

    steps:
    - name: üì• Checkout –∫–æ–¥
      uses: actions/checkout@v4
      
    - name: üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç –î–û –¥–µ–ø–ª–æ—è
      run: |
        echo "=== –î–û –¥–µ–ø–ª–æ—è ==="
        ls -la /opt/ || echo "–ü–∞–ø–∫–∞ /opt/ –ø—É—Å—Ç–∞—è"
        echo "================"
      
    - name: üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: |
        sudo mkdir -p /opt/calculator
        sudo chown $USER:$USER /opt/calculator
        
    - name: üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –í–°–ï–• —Ñ–∞–π–ª–æ–≤
      run: |
        echo "–ö–æ–ø–∏—Ä—É–µ–º –í–°–ï —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞..."
        cp -r * /opt/calculator/
        cp -r .github /opt/calculator/ 2>/dev/null || true
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        cd /opt/calculator
        pip3 install -r requirements.txt
        
    - name: üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
      run: |
        pkill -f "python3 app.py" || true
        sleep 2
        
    - name: üéØ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      run: |
        cd /opt/calculator
        nohup python3 app.py > app.log 2>&1 &
        sleep 3
        
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        curl -f http://localhost:5000/health || echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"
        
    - name: üì∏ –°–∫—Ä–∏–Ω—à–æ—Ç –ü–û–°–õ–ï –¥–µ–ø–ª–æ—è
      run: |
        echo "=== –ü–û–°–õ–ï –¥–µ–ø–ª–æ—è ==="
        ls -la /opt/calculator/
        echo "=================="